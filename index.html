<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“¦åŸå“ä¿æª¢é©—è¡¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; }
        .kpi-num { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .kpi-label { font-size: 0.9rem; color: #7f8c8d; }
        /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.85rem; color: white; font-weight: bold; }
        .bg-pass { background-color: #28a745; } /* ç¶ è‰²ï¼šåˆæ ¼ */
        .bg-fail { background-color: #dc3545; } /* ç´…è‰²ï¼šä¸åˆæ ¼ */
        .bg-warn { background-color: #ffc107; color: #000; } /* é»ƒè‰²ï¼šå…¶ä»–ç‹€æ³ */
        
        #loader { text-align: center; margin-top: 50px; }
        #dashboard { display: none; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ›¡ï¸ æ³°å±±å“ä¿æª¢é©—æˆ°æƒ…å®¤</h2>
            <small class="text-muted">è³‡æ–™ä¾†æº: GitHub (data.json)</small>
        </div>

        <div id="loader">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">æ­£åœ¨è®€å–æœ€æ–°æª¢é©—æ•¸æ“š...</p>
        </div>

        <div id="dashboard">
            <div class="row">
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="kpi-label">ç¸½æª¢é©—ç­†æ•¸</div>
                        <div class="kpi-num" id="total-count">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="kpi-label">åˆæ ¼ç‡ (Yield)</div>
                        <div class="kpi-num text-success" id="pass-rate">0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="kpi-label">ç•°å¸¸/ä¸åˆæ ¼æ•¸</div>
                        <div class="kpi-num text-danger" id="fail-count">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <div class="kpi-label">æœ€è¿‘æª¢é©—æ—¥æœŸ</div>
                        <div class="kpi-num" id="latest-date" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">ğŸ“… æ¯æ—¥æª¢é©—é‡è¶¨å‹¢</div>
                        <div class="card-body">
                            <canvas id="dailyChart" height="100"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">ğŸ“Š æª¢é©—çµæœåˆ†ä½ˆ</div>
                        <div class="card-body">
                            <canvas id="statusChart" height="220"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header text-danger d-flex justify-content-between align-items-center">
                            <span>âš ï¸ ç•°å¸¸èˆ‡ä¸åˆæ ¼ç›£æ§æ¸…å–® (éœ€é—œæ³¨é …ç›®)</span>
                        </div>
                        <div class="card-body table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å» å•†</th>
                                        <th>å“å</th>
                                        <th>åˆ¤å®šçµæœ</th>
                                        <th>ç•°å¸¸ç‹€æ³èªªæ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="abnormal-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”´ é—œéµè¨­å®šï¼šé€™è£¡æ”¹æˆè®€å–åŒä¸€å±¤ç›®éŒ„ä¸‹çš„ data.json
        // åŠ ä¸Š ?t=... æ˜¯ç‚ºäº†é˜²æ­¢ç€è¦½å™¨å·æ‡¶ç”¨èˆŠçš„å¿«å–è³‡æ–™
        const apiURL = './data.json'; 

        async function init() {
            try {
                const response = await fetch(apiURL + "?t=" + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error("ç„¡æ³•è®€å– data.jsonï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨æ–¼ GitHub");
                }

                const rawData = await response.json();
                processData(rawData);
                console.log("è³‡æ–™è¼‰å…¥æˆåŠŸï¼å…± " + rawData.length + " ç­†");

            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>è®€å–å¤±æ•—ï¼</strong><br>
                        æ‰¾ä¸åˆ° data.json æª”æ¡ˆã€‚<br>
                        è«‹ç¢ºèª Apps Script æ˜¯å¦å·²æˆåŠŸåŸ·è¡Œä¸¦ç”¢å‡ºæª”æ¡ˆã€‚
                    </div>`;
            }
        }

        function processData(data) {
            let total = 0;
            let passCount = 0;
            let failCount = 0;
            let dateMap = {}; // ç”¨ä¾†è¨ˆç®—æ¯å¤©çš„æ•¸é‡
            let abnormalList = []; // ç•°å¸¸æ¸…å–®

            // --- æ™ºæ…§æ¬„ä½å°æ‡‰ ---
            // é˜²æ­¢ Google Sheet æ¨™é¡Œæœ‰æ›è¡Œç¬¦è™Ÿæˆ–ç©ºç™½ï¼Œæˆ‘å€‘ç”¨é—œéµå­—å»æŠ“æ¬„ä½åç¨±
            const keys = data.length > 0 ? Object.keys(data[0]) : [];
            
            // å°‹æ‰¾åŒ…å«é—œéµå­—çš„æ¬„ä½åç¨±
            const statusKey = keys.find(k => k.includes("åˆ¤å®š")) || "åˆ¤å®š";
            const dateKey = keys.find(k => k.includes("æ—¥")) || "é€²è²¨/ç”Ÿç”¢æ—¥";
            const abnormalKey = keys.find(k => k.includes("ç•°å¸¸")) || "ç•°å¸¸ç‹€æ³";
            const vendorKey = keys.find(k => k.includes("å» å•†")) || "å» å•†";
            const itemKey = keys.find(k => k.includes("å“å")) || "å“å";

            let dates = [];

            // --- é–‹å§‹åˆ†æè³‡æ–™ ---
            data.forEach(item => {
                // æ’é™¤å…¨ç©ºçš„è¡Œ
                if (!item[statusKey] && !item[dateKey]) return;

                total++;
                
                // å–å¾—è©²åˆ—è³‡æ–™
                let status = String(item[statusKey] || "").trim();
                let date = String(item[dateKey] || "").trim();
                let issue = String(item[abnormalKey] || "").trim();

                // åˆ¤æ–·åˆæ ¼/ä¸åˆæ ¼
                let isFail = status.includes("ä¸åˆæ ¼");

                if (isFail) {
                    failCount++;
                    abnormalList.push(item); // ä¸åˆæ ¼ä¸€å®šåŠ å…¥æ¸…å–®
                } else {
                    passCount++;
                }

                // å¦‚æœé›–ç„¶åˆæ ¼ï¼Œä½†æœ‰å¯«ç•°å¸¸ç‹€æ³ (ä¾‹å¦‚ï¼šå…æ”¶æœŸä¸è¶³)ï¼Œä¹ŸåŠ å…¥æ¸…å–®æé†’
                if (!isFail && issue !== "") {
                    abnormalList.push(item);
                }

                // çµ±è¨ˆæ—¥æœŸ (æ ¼å¼åŒ–ç‚º YYYY-MM-DD)
                if (date) {
                    let dateStr = date.substring(0, 10); // åªå–å‰10ç¢¼
                    dateMap[dateStr] = (dateMap[dateStr] || 0) + 1;
                    dates.push(dateStr);
                }
            });

            // æ‰¾å‡ºæœ€è¿‘çš„ä¸€å€‹æ—¥æœŸ
            dates.sort();
            const latestDate = dates.length > 0 ? dates[dates.length - 1] : "-";

            // --- æ›´æ–°ç•«é¢æ•¸æ“š ---
            document.getElementById('total-count').innerText = total;
            document.getElementById('pass-rate').innerText = total > 0 ? Math.round((passCount / total) * 100) + "%" : "0%";
            document.getElementById('fail-count').innerText = abnormalList.length;
            document.getElementById('latest-date').innerText = latestDate;

            // --- ç¹ªè£½é•·æ¢åœ– (æ¯æ—¥è¶¨å‹¢) ---
            const sortedDates = Object.keys(dateMap).sort();
            const dailyCounts = sortedDates.map(d => dateMap[d]);

            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'æª¢é©—ç­†æ•¸',
                        data: dailyCounts,
                        backgroundColor: '#3498db',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // --- ç¹ªè£½åœ“é¤…åœ– (åˆæ ¼åˆ†ä½ˆ) ---
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['åˆæ ¼', 'ç•°å¸¸/ä¸åˆæ ¼'],
                    datasets: [{
                        data: [passCount, failCount],
                        backgroundColor: ['#2ecc71', '#e74c3c'] // ç¶ è‰² vs ç´…è‰²
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // --- æ¸²æŸ“ç•°å¸¸è¡¨æ ¼ ---
            const tableBody = document.getElementById('abnormal-table-body');
            
            if (abnormalList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">âœ¨ å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰ä»»ä½•ç•°å¸¸ç´€éŒ„ã€‚</td></tr>';
            } else {
                let html = "";
                abnormalList.forEach(item => {
                    let status = String(item[statusKey] || "");
                    let issue = String(item[abnormalKey] || "");
                    
                    // è¨­å®šæ¨™ç±¤é¡è‰²
                    let badgeClass = status.includes("ä¸åˆæ ¼") ? "bg-fail" : "bg-warn";
                    
                    html += `
                        <tr>
                            <td>${(item[dateKey] || "").substring(0, 10)}</td>
                            <td>${item[vendorKey] || ''}</td>
                            <td>${item[itemKey] || ''}</td>
                            <td><span class="status-badge ${badgeClass}">${status}</span></td>
                            <td class="text-danger fw-bold">${issue}</td>
                        </tr>`;
                });
                tableBody.innerHTML = html;
            }

            // ç§»é™¤ Loadingï¼Œé¡¯ç¤º Dashboard
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // å•Ÿå‹•ç¨‹å¼
        init();
    </script>
</body>
</html>
