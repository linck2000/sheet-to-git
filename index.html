<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ä¿æª¢é©—æˆ°æƒ…çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; }
        .kpi-num { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .kpi-label { font-size: 0.9rem; color: #7f8c8d; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.8rem; color: white;}
        .bg-pass { background-color: #28a745; }
        .bg-fail { background-color: #dc3545; }
        #loader { text-align: center; margin-top: 50px; }
        #dashboard { display: none; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h2 class="mb-4">ğŸ“‹ å“ä¿æª¢é©—ç´€éŒ„å„€è¡¨æ¿ (CSVç‰ˆ)</h2>

        <div id="loader">
            <div class="spinner-border text-primary" role="status"></div>
            <p>æ­£åœ¨è®€å–è³‡æ–™...</p>
        </div>

        <div id="dashboard">
            <div class="row">
                <div class="col-md-3"><div class="card p-3 text-center"><div class="kpi-label">ç¸½æª¢é©—ç­†æ•¸</div><div class="kpi-num" id="total-count">0</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><div class="kpi-label">åˆæ ¼ç‡ (Yield)</div><div class="kpi-num text-success" id="pass-rate">0%</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><div class="kpi-label">ç•°å¸¸/ä¸åˆæ ¼æ•¸</div><div class="kpi-num text-danger" id="fail-count">0</div></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><div class="kpi-label">æœ€è¿‘æª¢é©—æ—¥æœŸ</div><div class="kpi-num" id="latest-date" style="font-size: 1.5rem;">-</div></div></div>
            </div>

            <div class="row">
                <div class="col-md-8"><div class="card"><div class="card-header">ğŸ“… è¿‘æœŸæ¯æ—¥æª¢é©—é‡</div><div class="card-body"><canvas id="dailyChart" height="100"></canvas></div></div></div>
                <div class="col-md-4"><div class="card"><div class="card-header">ğŸ“Š åˆæ ¼ç‹€æ³åˆ†ä½ˆ</div><div class="card-body"><canvas id="statusChart" height="220"></canvas></div></div></div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header text-danger">âš ï¸ ç•°å¸¸èˆ‡ä¸åˆæ ¼æ¸…å–®</div>
                        <div class="card-body table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr><th>æ—¥æœŸ</th><th>å» å•†</th><th>å“å</th><th>åˆ¤å®šçµæœ</th><th>ç•°å¸¸ç‹€æ³</th></tr>
                                </thead>
                                <tbody id="abnormal-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”´ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ å‰›å‰›è¤‡è£½çš„ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€çš„ CSV ç¶²å€ ğŸ”´
        const csvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRCxQ7YIbDhkrCED_95koQmVzaY7tFY_NmbgKlJn7TWe4gvra7gVfs3gAJ_phQ0Db7NYDzLz78WaYGC/pub?gid=0&single=true&output=csv';

        function init() {
            Papa.parse(csvURL, {
                download: true,
                header: true, // å‘Šè¨´ç¨‹å¼ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
                complete: function(results) {
                    console.log("è³‡æ–™è®€å–æˆåŠŸ", results.data);
                    processData(results.data);
                },
                error: function(err) {
                    console.error("è®€å–å¤±æ•—:", err);
                    alert("ç„¡æ³•è®€å–è³‡æ–™ï¼Œå¯èƒ½æ˜¯å…¬å¸ç¶²åŸŸé™åˆ¶äº†ã€Œç™¼å¸ƒåˆ°ç¶²è·¯ã€çš„æ¬Šé™ã€‚");
                    document.getElementById('loader').innerHTML = "<p class='text-danger'>è³‡æ–™è®€å–å—é™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æˆ–æ”¹ç”¨ Looker Studioã€‚</p>";
                }
            });
        }

        function processData(data) {
            let total = 0, passCount = 0, failCount = 0;
            let dateMap = {};
            let abnormalList = [];

            // å˜—è©¦è‡ªå‹•æŠ“å–æ¬„ä½åç¨±ï¼Œé˜²æ­¢åç¨±æœ‰å¾®å°å·®ç•°
            const keys = data.length > 0 ? Object.keys(data[0]) : [];
            const statusKey = keys.find(k => k.includes("åˆ¤å®š")) || "åˆ¤å®š";
            const dateKey = keys.find(k => k.includes("æ—¥")) || "é€²è²¨/ç”Ÿç”¢æ—¥";
            const abnormalKey = keys.find(k => k.includes("ç•°å¸¸")) || "ç•°å¸¸ç‹€æ³";
            const vendorKey = keys.find(k => k.includes("å» å•†")) || "å» å•†";
            const itemKey = keys.find(k => k.includes("å“å")) || "å“å";

            let dates = [];

            data.forEach(item => {
                // éæ¿¾æ‰ç©ºè¡Œ
                if (!item[statusKey] && !item[dateKey]) return;

                total++;
                let status = item[statusKey] || "";
                let date = item[dateKey] || "";
                let issue = item[abnormalKey] || "";

                if (status.includes("ä¸åˆæ ¼")) {
                    failCount++;
                    abnormalList.push(item);
                } else {
                    passCount++;
                }

                // ç•°å¸¸ç‹€æ³æœ‰å¯«å­—ä¹Ÿè¦åˆ—å…¥
                if (issue && issue.trim() !== "" && !status.includes("ä¸åˆæ ¼")) {
                    abnormalList.push(item);
                }

                // æ—¥æœŸè™•ç†
                if (date) {
                    // å¦‚æœ CSV æ—¥æœŸæ ¼å¼æ˜¯ 2025-11-19
                    let cleanDate = date.substring(0, 10);
                    dateMap[cleanDate] = (dateMap[cleanDate] || 0) + 1;
                    dates.push(cleanDate);
                }
            });

            dates.sort();
            let latestDate = dates[dates.length - 1] || "-";

            // æ›´æ–°ç•«é¢
            document.getElementById('total-count').innerText = total;
            document.getElementById('pass-rate').innerText = total > 0 ? Math.round((passCount / total) * 100) + "%" : "0%";
            document.getElementById('fail-count').innerText = abnormalList.length;
            document.getElementById('latest-date').innerText = latestDate;

            // åœ–è¡¨
            const sortedDates = Object.keys(dateMap).sort();
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{ label: 'æª¢é©—ç­†æ•¸', data: sortedDates.map(d => dateMap[d]), backgroundColor: '#3498db' }]
                }
            });

            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['åˆæ ¼', 'ä¸åˆæ ¼/ç•°å¸¸'],
                    datasets: [{ data: [passCount, failCount], backgroundColor: ['#2ecc71', '#e74c3c'] }]
                }
            });

            // è¡¨æ ¼
            const tableBody = document.getElementById('abnormal-table-body');
            if (abnormalList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">âœ¨ ç„¡ç•°å¸¸è³‡æ–™</td></tr>';
            } else {
                abnormalList.forEach(item => {
                    let badgeClass = (item[statusKey] || "").includes("ä¸åˆæ ¼") ? "bg-fail" : "bg-warning text-dark";
                    tableBody.innerHTML += `
                        <tr>
                            <td>${(item[dateKey] || "").substring(0, 10)}</td>
                            <td>${item[vendorKey] || ''}</td>
                            <td>${item[itemKey] || ''}</td>
                            <td><span class="status-badge ${badgeClass}">${item[statusKey] || ''}</span></td>
                            <td class="text-danger">${item[abnormalKey] || ''}</td>
                        </tr>`;
                });
            }

            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        init();
    </script>
</body>
</html>
