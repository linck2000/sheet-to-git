<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“¦åŸå“ä¿æª¢é©—æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border-radius: 10px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; border-radius: 10px 10px 0 0 !important; }
        .kpi-num { font-size: 2.2rem; font-weight: 800; color: #2c3e50; }
        .kpi-label { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; }
        
        /* ç‹€æ…‹æ¨™ç±¤æ¨£å¼ */
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; color: white; font-weight: bold; box-shadow: 0 2px 2px rgba(0,0,0,0.1); }
        .bg-pass { background-color: #2ecc71; } /* é®®ç¶ è‰² */
        .bg-fail { background-color: #e74c3c; } /* é®®ç´…è‰² */
        .bg-warn { background-color: #f1c40f; color: #333; } /* é»ƒè‰² */
        
        #loader { text-align: center; margin-top: 50px; }
        #dashboard { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold">ğŸ›¡ï¸ ç“¦åŸå“ä¿æª¢é©—æˆ°æƒ…å®¤</h2>
                <small class="text-muted">æœ€å¾Œæ›´æ–°æ™‚é–“: <span id="last-update-time">-</span></small>
            </div>
            <a href="javascript:location.reload()" class="btn btn-outline-primary btn-sm">ğŸ”„ é‡æ–°æ•´ç†</a>
        </div>

        <div id="loader">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-primary fw-bold">æ­£åœ¨åˆ†æ 494 ç­†æª¢é©—æ•¸æ“š...</p>
        </div>

        <div id="dashboard">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card p-3 text-center h-100 justify-content-center">
                        <div class="kpi-label">ç¸½æª¢é©—ç­†æ•¸</div>
                        <div class="kpi-num" id="total-count">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center h-100 justify-content-center">
                        <div class="kpi-label">åˆæ ¼ç‡ (Yield)</div>
                        <div class="kpi-num text-success" id="pass-rate">0%</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center h-100 justify-content-center">
                        <div class="kpi-label">ç•°å¸¸/ä¸åˆæ ¼æ•¸</div>
                        <div class="kpi-num text-danger" id="fail-count">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center h-100 justify-content-center">
                        <div class="kpi-label">æœ€è¿‘æª¢é©—æ—¥æœŸ</div>
                        <div class="kpi-num text-primary" id="latest-date" style="font-size: 1.8rem;">-</div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header">ğŸ“… æ¯æ—¥æª¢é©—é‡è¶¨å‹¢</div>
                        <div class="card-body">
                            <canvas id="dailyChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">ğŸ“Š æª¢é©—çµæœä½”æ¯”</div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            <canvas id="statusChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header text-danger d-flex align-items-center">
                            <span class="fs-5">âš ï¸ ç•°å¸¸èˆ‡ä¸åˆæ ¼ç›£æ§æ¸…å–®</span>
                        </div>
                        <div class="card-body table-responsive p-0">
                            <table class="table table-hover table-striped align-middle mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>æ—¥æœŸ</th>
                                        <th>å» å•†</th>
                                        <th>å“å</th>
                                        <th>åˆ¤å®šçµæœ</th>
                                        <th>ç•°å¸¸ç‹€æ³èªªæ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="abnormal-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const apiURL = './data.json'; 

        async function init() {
            try {
                // å¼·åˆ¶åŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œé¿å…è®€åˆ°èˆŠå¿«å–
                const response = await fetch(apiURL + "?t=" + new Date().getTime());
                const rawData = await response.json();
                
                // è¨­å®šæœ€å¾Œæ›´æ–°æ™‚é–“ç‚ºç•¶å‰æ™‚é–“
                const now = new Date();
                document.getElementById('last-update-time').innerText = now.toLocaleString('zh-TW');

                if (rawData.length > 0) {
                    processData(rawData);
                } else {
                    alert("è®€å–æˆåŠŸï¼Œä½†æª”æ¡ˆå…§æ²’æœ‰è³‡æ–™ (0ç­†)");
                    document.getElementById('loader').style.display = 'none';
                }

            } catch (error) {
                console.error(error);
                document.getElementById('loader').innerHTML = `<h4 class="text-danger">âŒ è³‡æ–™è®€å–å¤±æ•—</h4><p>è«‹æª¢æŸ¥ GitHub ä¸Šçš„ data.json æ˜¯å¦å­˜åœ¨</p>`;
            }
        }

        function processData(data) {
            // 1. æ¬„ä½è‡ªå‹•å°æ‡‰é‚è¼¯ (é€™æ®µæœ€é‡è¦)
            // æ‰¾å‡ºåŒ…å« "åˆ¤å®š" çš„é‚£å€‹æ¬„ä½åç¨± (è§£æ±º \n æ›è¡Œå•é¡Œ)
            const keys = Object.keys(data[0]);
            
            // ä½¿ç”¨ includes æ¨¡ç³Šæ¯”å°ï¼Œä¸ç®¡ä½ æ˜¯ "åˆ¤å®š" é‚„æ˜¯ "åˆ¤å®š\nåˆæ ¼..." éƒ½èƒ½æŠ“åˆ°
            const statusKey = keys.find(k => k.includes("åˆ¤å®š")) || "åˆ¤å®š";
            const dateKey = keys.find(k => k.includes("æ—¥")) || "é€²è²¨/ç”Ÿç”¢æ—¥";
            const abnormalKey = keys.find(k => k.includes("ç•°å¸¸")) || "ç•°å¸¸ç‹€æ³";
            const vendorKey = keys.find(k => k.includes("å» å•†")) || "å» å•†";
            const itemKey = keys.find(k => k.includes("å“å")) || "å“å";

            console.log("åµæ¸¬åˆ°çš„åˆ¤å®šæ¬„ä½:", statusKey); // Debugç”¨

            let total = 0, passCount = 0, failCount = 0;
            let dateMap = {};
            let abnormalList = [];
            let dates = [];

            data.forEach(item => {
                // å®‰å…¨è®€å–è³‡æ–™ (è½‰æˆå­—ä¸²ä¸¦å»é™¤å‰å¾Œç©ºç™½)
                let status = String(item[statusKey] || "").trim();
                let date = String(item[dateKey] || "").trim();
                let issue = String(item[abnormalKey] || "").trim();

                // è·³éç©ºè¡Œ
                if (!status && !date) return;

                total++;

                // åˆ¤å®šé‚è¼¯
                let isFail = status.includes("ä¸åˆæ ¼");

                if (isFail) {
                    failCount++;
                    abnormalList.push(item);
                } else {
                    passCount++;
                }

                // é›–ç„¶åˆæ ¼ä½†æœ‰ç•°å¸¸èªªæ˜ï¼Œä¹Ÿè¦åˆ—å‡ºä¾†
                if (!isFail && issue !== "") {
                    abnormalList.push(item);
                }

                // æ—¥æœŸçµ±è¨ˆ
                if (date) {
                    let dateStr = date.substring(0, 10); // å–å‰10ç¢¼ (YYYY-MM-DD)
                    dateMap[dateStr] = (dateMap[dateStr] || 0) + 1;
                    dates.push(dateStr);
                }
            });

            dates.sort();
            const latestDate = dates.length > 0 ? dates[dates.length - 1] : "N/A";

            // 2. æ›´æ–° KPI æ•¸å­—
            document.getElementById('total-count').innerText = total;
            document.getElementById('pass-rate').innerText = total > 0 ? Math.round((passCount / total) * 100) + "%" : "0%";
            document.getElementById('fail-count').innerText = abnormalList.length;
            document.getElementById('latest-date').innerText = latestDate;

            // 3. ç¹ªè£½æ¯æ—¥è¶¨å‹¢åœ–
            const sortedDates = Object.keys(dateMap).sort();
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'æª¢é©—ç­†æ•¸',
                        data: sortedDates.map(d => dateMap[d]),
                        backgroundColor: '#3498db',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // 4. ç¹ªè£½åœ“é¤…åœ–
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['åˆæ ¼', 'ç•°å¸¸/ä¸åˆæ ¼'],
                    datasets: [{
                        data: [passCount, failCount],
                        backgroundColor: ['#2ecc71', '#e74c3c']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 5. å¡«å¯«ç•°å¸¸è¡¨æ ¼
            const tableBody = document.getElementById('abnormal-table-body');
            if (abnormalList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">âœ¨ å¤ªæ£’äº†ï¼è¿‘æœŸç„¡ç•°å¸¸ç´€éŒ„</td></tr>';
            } else {
                let html = "";
                // ç‚ºäº†æ•ˆèƒ½ï¼Œåªé¡¯ç¤ºæœ€è¿‘ 100 ç­†ç•°å¸¸ (å¦‚æœæœ‰å¤ªå¤šçš„è©±)
                abnormalList.reverse().slice(0
