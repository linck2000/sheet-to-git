<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°å±±å“ä¿æˆ°æƒ…å®¤ (è¨ºæ–·æ¨¡å¼)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.85rem; color: white; font-weight: bold; }
        .bg-pass { background-color: #28a745; }
        .bg-fail { background-color: #dc3545; }
        .bg-warn { background-color: #ffc107; color: #000; }
        
        /* è¨ºæ–·å€å¡Šæ¨£å¼ */
        #debug-panel {
            background-color: #333;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            margin-bottom: 20px;
            white-space: pre-wrap;
            border: 2px solid #0f0;
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h2>ğŸ”§ ç³»çµ±è¨ºæ–·æ¨¡å¼</h2>
        
        <div id="debug-panel">æ­£åœ¨åˆ†æè³‡æ–™çµæ§‹...è«‹ç¨å€™...</div>

        <div id="dashboard" style="opacity: 0.5;">
            <div class="row">
                <div class="col-md-3"><div class="card p-3">ç¸½ç­†æ•¸: <span id="total-count">0</span></div></div>
                <div class="col-md-3"><div class="card p-3">åˆæ ¼ç‡: <span id="pass-rate">0%</span></div></div>
            </div>
            <div class="row">
                <div class="col-12"><div class="card p-3"><canvas id="dailyChart" height="50"></canvas></div></div>
            </div>
        </div>
    </div>

    <script>
        const apiURL = './data.json'; 

        async function init() {
            const debugPanel = document.getElementById('debug-panel');
            try {
                // å¼·åˆ¶åˆ·æ–°ä¸å¿«å–
                const response = await fetch(apiURL + "?t=" + new Date().getTime());
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ° data.json (404)");
                
                const rawData = await response.json();
                
                // --- è¨ºæ–·å ±å‘Š ---
                let report = "âœ… æˆåŠŸè®€å– data.json\n";
                report += "--------------------------------\n";
                report += `ğŸ“Š è³‡æ–™ç¸½ç­†æ•¸: ${rawData.length} ç­†\n`;

                if (rawData.length === 0) {
                    report += "âš ï¸ è­¦å‘Š: è³‡æ–™æ˜¯ç©ºçš„ï¼\n   -> è«‹æª¢æŸ¥ Apps Script æ˜¯å¦æŠ“éŒ¯å·¥ä½œè¡¨ï¼Ÿ\n   -> è«‹æª¢æŸ¥ Google Sheet æ˜¯å¦æœ‰è³‡æ–™ï¼Ÿ";
                } else {
                    // é¡¯ç¤ºç¬¬ä¸€ç­†è³‡æ–™çš„å®Œæ•´å…§å®¹ï¼Œè®“æˆ‘å€‘çœ‹æ¨™é¡Œåˆ°åº•é•·æ€æ¨£
                    const firstRow = rawData[0];
                    const keys = Object.keys(firstRow);
                    
                    report += `ğŸ”‘ åµæ¸¬åˆ°çš„æ¬„ä½åç¨± (Keys):\n[ ${keys.join(', ')} ]\n\n`;
                    report += "--------------------------------\n";
                    report += "ğŸ” æ¬„ä½åŒ¹é…æ¸¬è©¦:\n";
                    
                    const statusKey = keys.find(k => k.includes("åˆ¤å®š")) || "âŒ æœªæ‰¾åˆ° (åˆ¤å®š)";
                    const dateKey = keys.find(k => k.includes("æ—¥")) || "âŒ æœªæ‰¾åˆ° (æ—¥æœŸ)";
                    
                    report += `1. åˆ¤å®šæ¬„ä½: ${statusKey}\n`;
                    report += `2. æ—¥æœŸæ¬„ä½: ${dateKey}\n`;
                    
                    if (statusKey.includes("âŒ") || dateKey.includes("âŒ")) {
                        report += "\nâŒ å¤±æ•—åŸå› : æ‰¾ä¸åˆ°é—œéµæ¬„ä½ï¼Œè«‹æˆªåœ–æ­¤ç•«é¢çµ¦ AI ä¿®æ­£ç¨‹å¼ç¢¼ã€‚";
                    } else {
                        report += `\nâœ… åŒ¹é…æˆåŠŸï¼ç¬¬ä¸€ç­†åˆ¤å®šå€¼: "${firstRow[statusKey]}"`;
                        processData(rawData); // å˜—è©¦åŸ·è¡Œåœ–è¡¨
                    }
                }
                
                debugPanel.innerText = report;

            } catch (error) {
                debugPanel.innerText = "âŒ åš´é‡éŒ¯èª¤:\n" + error.message;
                debugPanel.style.color = "red";
                debugPanel.style.borderColor = "red";
            }
        }

        function processData(data) {
            // ç°¡åŒ–ç‰ˆç¹ªåœ–ï¼Œåƒ…æ¸¬è©¦ç”¨
            let total = data.length;
            let passCount = 0;
            const keys = Object.keys(data[0]);
            const statusKey = keys.find(k => k.includes("åˆ¤å®š"));
            
            data.forEach(item => {
                if(item[statusKey] && String(item[statusKey]).includes("åˆæ ¼")) passCount++;
            });

            document.getElementById('total-count').innerText = total;
            document.getElementById('pass-rate').innerText = Math.round((passCount/total)*100) + "%";
            
            new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: ['æ¸¬è©¦'],
                    datasets: [{ label: 'æ¸¬è©¦æ•¸æ“š', data: [total], backgroundColor: 'blue' }]
                }
            });
        }

        init();
    </script>
</body>
</html>
