<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°å±±å“ä¿æˆ°æƒ…å®¤ (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 0.85rem; color: white; font-weight: bold; }
        .bg-pass { background-color: #28a745; }
        .bg-fail { background-color: #dc3545; }
        .bg-warn { background-color: #ffc107; color: #000; }
        #loader { text-align: center; margin-top: 50px; }
        #error-box { display: none; text-align: left; background: #333; color: #ff5555; padding: 20px; margin-top: 20px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div class="container-fluid">
        <h2 class="fw-bold mb-3">ğŸ›¡ï¸ æ³°å±±å“ä¿æª¢é©—æˆ°æƒ…å®¤</h2>

        <div id="error-box"></div>

        <div id="loader">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2" id="loader-text">æ­£åœ¨é€£æ¥è³‡æ–™åº«...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="row g-3 mb-4">
                <div class="col-md-3"><div class="card p-3 text-center"><h5>ç¸½ç­†æ•¸</h5><h2 id="total-count">0</h2></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><h5>åˆæ ¼ç‡</h5><h2 class="text-success" id="pass-rate">0%</h2></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><h5>ç•°å¸¸æ•¸</h5><h2 class="text-danger" id="fail-count">0</h2></div></div>
                <div class="col-md-3"><div class="card p-3 text-center"><h5>æœ€æ–°æ—¥æœŸ</h5><h4 class="text-primary" id="latest-date">-</h4></div></div>
            </div>
            
            <div class="row g-3 mb-4">
                <div class="col-md-8"><div class="card p-3"><canvas id="dailyChart" style="max-height: 300px;"></canvas></div></div>
                <div class="col-md-4"><div class="card p-3"><canvas id="statusChart" style="max-height: 300px;"></canvas></div></div>
            </div>

            <div class="card p-3">
                <h5 class="text-danger">âš ï¸ ç•°å¸¸æ¸…å–®</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark"><tr><th>æ—¥æœŸ</th><th>å» å•†</th><th>å“å</th><th>åˆ¤å®š</th><th>èªªæ˜</th></tr></thead>
                        <tbody id="abnormal-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡¯ç¤ºéŒ¯èª¤çš„å·¥å…·å‡½å¼
        function showError(step, detail) {
            document.getElementById('loader').style.display = 'none';
            const box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerHTML = `âŒ éŒ¯èª¤ç™¼ç”Ÿåœ¨ï¼š[${step}]\n--------------------------\n${detail}\n\nè«‹æˆªåœ–æ­¤ç•«é¢çµ¦å·¥ç¨‹å¸« (AI)`;
        }

        const apiURL = './data.json'; 

        async function init() {
            try {
                // æ­¥é©Ÿ 1: æŠ“è³‡æ–™
                document.getElementById('loader-text').innerText = "æ­¥é©Ÿ 1/4: ä¸‹è¼‰è³‡æ–™ä¸­...";
                const response = await fetch(apiURL + "?t=" + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
                const rawData = await response.json();
                
                // æ­¥é©Ÿ 2: æª¢æŸ¥è³‡æ–™
                document.getElementById('loader-text').innerText = `æ­¥é©Ÿ 2/4: è³‡æ–™æª¢æ ¸ (å…±${rawData.length}ç­†)...`;
                if (!rawData || rawData.length === 0) throw new Error("è³‡æ–™æ˜¯ç©ºçš„ (0ç­†)");

                // æ­¥é©Ÿ 3: è™•ç†è³‡æ–™
                document.getElementById('loader-text').innerText = "æ­¥é©Ÿ 3/4: é–‹å§‹é‹ç®—...";
                processData(rawData);

            } catch (error) {
                showError("åˆå§‹åŒ–éšæ®µ", error.message + "\n" + error.stack);
            }
        }

        function processData(data) {
            try {
                // è‡ªå‹•æŠ“æ¬„ä½
                const keys = Object.keys(data[0]);
                const statusKey = keys.find(k => k.includes("åˆ¤å®š")) || "åˆ¤å®š";
                const dateKey = keys.find(k => k.includes("æ—¥")) || "é€²è²¨/ç”Ÿç”¢æ—¥";
                const abnormalKey = keys.find(k => k.includes("ç•°å¸¸")) || "ç•°å¸¸ç‹€æ³";
                const vendorKey = keys.find(k => k.includes("å» å•†")) || "å» å•†";
                const itemKey = keys.find(k => k.includes("å“å")) || "å“å";

                let total = 0, passCount = 0, failCount = 0;
                let dateMap = {};
                let abnormalList = [];
                let dates = [];

                data.forEach((item, index) => {
                    try {
                        let status = String(item[statusKey] || "").trim();
                        let date = String(item[dateKey] || "").trim();
                        let issue = String(item[abnormalKey] || "").trim();

                        if (!status && !date) return;
                        total++;

                        let isFail = status.includes("ä¸åˆæ ¼");
                        if (isFail) {
                            failCount++;
                            abnormalList.push(item);
                        } else {
                            passCount++;
                        }
                        if (!isFail && issue !== "") abnormalList.push(item);

                        if (date) {
                            // ä¿®æ­£ï¼šæœ‰äº›æ—¥æœŸå¯èƒ½æ˜¯ Excel åºåˆ—è™Ÿï¼Œè½‰æˆå­—ä¸²
                            let dateStr = date.substring(0, 10);
                            dateMap[dateStr] = (dateMap[dateStr] || 0) + 1;
                            dates.push(dateStr);
                        }
                    } catch (err) {
                        console.warn(`ç¬¬ ${index} ç­†è³‡æ–™æœ‰å•é¡Œï¼Œè·³é:`, err);
                    }
                });

                dates.sort();
                
                // æ›´æ–°æ•¸å­—
                document.getElementById('total-count').innerText = total;
                document.getElementById('pass-rate').innerText = total > 0 ? Math.round((passCount / total) * 100) + "%" : "0%";
                document.getElementById('fail-count').innerText = abnormalList.length;
                document.getElementById('latest-date').innerText = dates.length > 0 ? dates[dates.length - 1] : "-";

                // æ­¥é©Ÿ 4: ç¹ªåœ–
                document.getElementById('loader-text').innerText = "æ­¥é©Ÿ 4/4: ç¹ªè£½åœ–è¡¨...";
                
                if (typeof Chart === 'undefined') throw new Error("Chart.js å‡½å¼åº«è¼‰å…¥å¤±æ•— (å¯èƒ½æ˜¯å…¬å¸ç¶²è·¯æ“‹ä½äº† CDN)");

                const sortedDates = Object.keys(dateMap).sort();
                
                // æ¯æ—¥åœ–è¡¨
                new Chart(document.getElementById('dailyChart'), {
                    type: 'bar',
                    data: {
                        labels: sortedDates,
                        datasets: [{ label: 'æª¢é©—é‡', data: sortedDates.map(d => dateMap[d]), backgroundColor: '#3498db' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // åœ“é¤…åœ–
                new Chart(document.getElementById('statusChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['åˆæ ¼', 'ç•°å¸¸'],
                        datasets: [{ data: [passCount, failCount], backgroundColor: ['#2ecc71', '#e74c3c'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // å¡«è¡¨
                const tableBody = document.getElementById('abnormal-table-body');
                let html = "";
                abnormalList.slice(0, 50).forEach(item => { // åªé¡¯ç¤ºå‰50ç­†é¿å…å¡é “
                    let s = String(item[statusKey]||"");
                    let badge = s.includes("ä¸åˆæ ¼") ? "bg-fail" : "bg-warn";
                    html += `<tr>
                        <td>${(item[dateKey]||"").substring(0,10)}</td>
                        <td>${item[vendorKey]||""}</td>
                        <td>${item[itemKey]||""}</td>
                        <td><span class="status-badge ${badge}">${s}</span></td>
                        <td class="text-danger">${item[abnormalKey]||""}</td>
                    </tr>`;
                });
                tableBody.innerHTML = html || '<tr><td colspan="5" class="text-center">ç„¡ç•°å¸¸</td></tr>';

                // å®Œæˆ
                document.getElementById('loader').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (error) {
                showError("æ•¸æ“šè™•ç†éšæ®µ", error.message + "\n" + error.stack);
            }
        }

        init();
    </script>
</body>
</html>
